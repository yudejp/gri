services:
  gri:
    hostname: gri
    build:
      context: .
    image: ghcr.io/yudejp/gri:latest
    container_name: gri
    restart: always
    environment:
      - TZ=Asia/Tokyo
    command:
      - sh
      - -lc
      - |
        set -eu
        /usr/local/bundle/bin/grapher -h 0.0.0.0 -p 9292 &
        web_pid=$$!
        trap 'kill "$$web_pid" 2>/dev/null || true; exit 0' INT TERM
        while true; do
          if ! kill -0 "$$web_pid" 2>/dev/null; then
            echo "grapher exited" >&2
            exit 1
          fi
          /usr/local/bundle/bin/gri
          sleep "$${GRI_INTERVAL:-300}"
        done
